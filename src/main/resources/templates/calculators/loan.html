<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/base :: layout(~{::content})}">

<div th:fragment="content">
    <!-- Page Header -->
    <header class="text-center mb-8 pb-6 border-b border-gray-200">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-3">Loan Calculator</h1>
        <p class="text-lg text-gray-600 max-w-2xl mx-auto">
            Calculate loan payments, interest rates, and repayment schedules for personal loans, auto loans, and more.
        </p>
    </header>

    <!-- Calculator Container -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
        <!-- Form Section -->
        <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
            <form id="loan-form" class="space-y-6">
                <!-- Loan Amount & Interest Rate -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="loan-amount" class="block text-sm font-semibold text-gray-700 mb-2">Loan Amount</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm">$</span>
                            <input type="number" id="loan-amount" name="loanAmount"
                                   class="w-full pl-8 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                                   value="25000" min="100" max="1000000" step="100" required>
                        </div>
                    </div>

                    <div>
                        <label for="interest-rate" class="block text-sm font-semibold text-gray-700 mb-2">Annual Interest Rate</label>
                        <div class="relative">
                            <input type="number" id="interest-rate" name="interestRate"
                                   class="w-full pl-4 pr-8 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                                   value="7.5" min="0.1" max="30" step="0.01" required>
                            <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm">%</span>
                        </div>
                    </div>
                </div>

                <!-- Loan Term & Payment Frequency -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="loan-term" class="block text-sm font-semibold text-gray-700 mb-2">Loan Term</label>
                        <select id="loan-term" name="loanTerm"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                            <option value="12">1 year</option>
                            <option value="24">2 years</option>
                            <option value="36">3 years</option>
                            <option value="48">4 years</option>
                            <option value="60" selected>5 years</option>
                            <option value="84">7 years</option>
                            <option value="120">10 years</option>
                        </select>
                    </div>

                    <div>
                        <label for="payment-frequency" class="block text-sm font-semibold text-gray-700 mb-2">Payment Frequency</label>
                        <select id="payment-frequency" name="paymentFrequency"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                            <option value="monthly" selected>Monthly</option>
                            <option value="biweekly">Bi-weekly</option>
                            <option value="weekly">Weekly</option>
                        </select>
                    </div>
                </div>

                <!-- Loan Type -->
                <div>
                    <label for="loan-type" class="block text-sm font-semibold text-gray-700 mb-2">Loan Type</label>
                    <select id="loan-type" name="loanType"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                        <option value="personal">Personal Loan</option>
                        <option value="auto" selected>Auto Loan</option>
                        <option value="home-equity">Home Equity Loan</option>
                        <option value="student">Student Loan</option>
                        <option value="business">Business Loan</option>
                    </select>
                </div>

                <!-- Calculate Button -->
                <button type="submit"
                        class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors duration-200 shadow-lg hover:shadow-xl">
                    Calculate Payment
                </button>
            </form>
        </div>

        <!-- Results Section -->
        <div id="loan-results" class="space-y-6">
            <!-- Payment Summary -->
            <div class="bg-white border border-gray-200 rounded-xl p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 pb-2 border-b-2 border-blue-500">
                    Payment Summary
                </h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <span class="text-sm font-semibold text-blue-900">Monthly Payment</span>
                        <span class="text-lg font-bold text-blue-600" id="monthly-payment">$503.26</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span class="text-sm font-medium text-gray-700">Total Interest Paid</span>
                        <span class="text-sm font-semibold text-gray-900" id="total-interest">$5,195.60</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span class="text-sm font-medium text-gray-700">Total Amount Paid</span>
                        <span class="text-sm font-semibold text-gray-900" id="total-amount">$30,195.60</span>
                    </div>
                </div>
            </div>

            <!-- Loan Details -->
            <div class="bg-white border border-gray-200 rounded-xl p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 pb-2 border-b-2 border-blue-500">
                    Loan Details
                </h3>
                <div class="grid grid-cols-2 gap-4">
                    <div class="text-center p-3 bg-gray-50 rounded-lg">
                        <div class="text-xs text-gray-500 mb-1">Principal Amount</div>
                        <div class="text-sm font-semibold text-gray-900" id="principal-amount">$25,000</div>
                    </div>
                    <div class="text-center p-3 bg-gray-50 rounded-lg">
                        <div class="text-xs text-gray-500 mb-1">Annual Rate</div>
                        <div class="text-sm font-semibold text-gray-900" id="annual-rate">7.50%</div>
                    </div>
                    <div class="text-center p-3 bg-gray-50 rounded-lg">
                        <div class="text-xs text-gray-500 mb-1">Loan Term</div>
                        <div class="text-sm font-semibold text-gray-900" id="loan-duration">5 years</div>
                    </div>
                    <div class="text-center p-3 bg-gray-50 rounded-lg">
                        <div class="text-xs text-gray-500 mb-1">Total Payments</div>
                        <div class="text-sm font-semibold text-gray-900" id="number-payments">60</div>
                    </div>
                </div>
            </div>

            <!-- Chart Container -->
            <div class="bg-white border border-gray-200 rounded-xl p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 text-center">Payment Breakdown</h3>
                <div class="relative h-64">
                    <canvas id="loan-chart" class="w-full h-full"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Schedule -->
    <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
        <h3 class="text-xl font-semibold text-gray-900 mb-6 pb-3 border-b-2 border-blue-500">
            Payment Schedule (First 12 Payments)
        </h3>
        <div class="overflow-x-auto">
            <table id="payment-schedule-table" class="w-full bg-white rounded-lg overflow-hidden shadow-sm border border-gray-200">
                <thead class="bg-gray-100">
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Payment #</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Payment Date</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Payment Amount</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Principal</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Interest</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Remaining Balance</th>
                </tr>
                </thead>
                <tbody id="schedule-tbody" class="divide-y divide-gray-200">
                <!-- Populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // Loan Calculator JavaScript with Tailwind
    class LoanCalculator {
        constructor() {
            this.form = document.querySelector('#loan-form');
            this.chart = null;
            this.init();
        }

        init() {
            if (this.form) {
                this.form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.calculate();
                });

                // Real-time calculation
                this.form.addEventListener('input', () => {
                    this.calculate();
                });

                // Initial calculation
                this.calculate();
            }
        }

        calculate() {
            try {
                const inputs = this.getInputValues();
                const results = this.calculateLoan(inputs);
                this.updateResults(results);
                this.generatePaymentSchedule(results);
                this.createChart(results);
            } catch (error) {
                console.error('Loan calculation error:', error);
            }
        }

        getInputValues() {
            return {
                loanAmount: parseFloat(this.form.querySelector('#loan-amount').value) || 0,
                interestRate: parseFloat(this.form.querySelector('#interest-rate').value) || 0,
                loanTerm: parseInt(this.form.querySelector('#loan-term').value) || 60,
                paymentFrequency: this.form.querySelector('#payment-frequency').value || 'monthly',
                loanType: this.form.querySelector('#loan-type').value || 'personal'
            };
        }

        calculateLoan(inputs) {
            const principal = inputs.loanAmount;
            let periodsPerYear = 12; // monthly by default

            if (inputs.paymentFrequency === 'biweekly') periodsPerYear = 26;
            if (inputs.paymentFrequency === 'weekly') periodsPerYear = 52;

            const periodRate = inputs.interestRate / 100 / periodsPerYear;
            const numPayments = inputs.loanTerm * (periodsPerYear / 12);

            // Calculate payment amount
            let paymentAmount = 0;
            if (periodRate > 0) {
                paymentAmount = principal * (periodRate * Math.pow(1 + periodRate, numPayments)) /
                    (Math.pow(1 + periodRate, numPayments) - 1);
            } else {
                paymentAmount = principal / numPayments;
            }

            const totalPayment = paymentAmount * numPayments;
            const totalInterest = totalPayment - principal;

            return {
                principal,
                paymentAmount,
                totalPayment,
                totalInterest,
                numPayments,
                periodRate,
                periodsPerYear,
                paymentFrequency: inputs.paymentFrequency
            };
        }

        updateResults(results) {
            const frequencyText = results.paymentFrequency === 'monthly' ? 'Monthly' :
                results.paymentFrequency === 'biweekly' ? 'Bi-weekly' : 'Weekly';

            document.querySelector('#monthly-payment').textContent = this.formatCurrency(results.paymentAmount);
            document.querySelector('#total-interest').textContent = this.formatCurrency(results.totalInterest);
            document.querySelector('#total-amount').textContent = this.formatCurrency(results.totalPayment);
            document.querySelector('#principal-amount').textContent = this.formatCurrency(results.principal);
            document.querySelector('#annual-rate').textContent =
                this.form.querySelector('#interest-rate').value + '%';
            document.querySelector('#loan-duration').textContent =
                (results.numPayments / (results.periodsPerYear / 12)).toFixed(1) + ' years';
            document.querySelector('#number-payments').textContent = Math.round(results.numPayments);

            // Update payment label
            const paymentLabel = document.querySelector('#monthly-payment').previousElementSibling;
            paymentLabel.textContent = `${frequencyText} Payment`;
        }

        generatePaymentSchedule(results) {
            const tbody = document.querySelector('#schedule-tbody');
            if (!tbody) return;

            tbody.innerHTML = '';
            let balance = results.principal;
            const currentDate = new Date();
            const paymentsToShow = Math.min(12, results.numPayments);

            for (let i = 1; i <= paymentsToShow; i++) {
                const interestPayment = balance * results.periodRate;
                const principalPayment = results.paymentAmount - interestPayment;
                balance -= principalPayment;

                const paymentDate = new Date(currentDate);
                if (results.paymentFrequency === 'monthly') {
                    paymentDate.setMonth(paymentDate.getMonth() + i);
                } else if (results.paymentFrequency === 'biweekly') {
                    paymentDate.setDate(paymentDate.getDate() + (i * 14));
                } else { // weekly
                    paymentDate.setDate(paymentDate.getDate() + (i * 7));
                }

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                <td class="px-4 py-3 text-sm text-center text-gray-900">${i}</td>
                <td class="px-4 py-3 text-sm text-gray-900">${paymentDate.toLocaleDateString()}</td>
                <td class="px-4 py-3 text-sm text-right text-gray-900">${this.formatCurrency(results.paymentAmount)}</td>
                <td class="px-4 py-3 text-sm text-right text-gray-900">${this.formatCurrency(principalPayment)}</td>
                <td class="px-4 py-3 text-sm text-right text-gray-900">${this.formatCurrency(interestPayment)}</td>
                <td class="px-4 py-3 text-sm text-right text-gray-900">${this.formatCurrency(Math.max(0, balance))}</td>
            `;
                tbody.appendChild(row);
            }
        }

        createChart(results) {
            const canvas = document.querySelector('#loan-chart');
            if (!canvas || typeof Chart === 'undefined') return;

            // Destroy existing chart if it exists
            if (this.chart) {
                this.chart.destroy();
            }

            const ctx = canvas.getContext('2d');
            this.chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Principal', 'Interest'],
                    datasets: [{
                        data: [results.principal, results.totalInterest],
                        backgroundColor: [
                            '#3b82f6',
                            '#93c5fd'
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }
    }

    // Initialize calculator when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        new LoanCalculator();
    });
</script>

</html>